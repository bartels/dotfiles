# vi: ft=sh

. ~/.bash_completions/django_bash_completion

# Django dev environment setup
djstart() {
    # Get the settings.py file path
    dir="$(pwd -P)"
    settings_path=$(dirname "$(find "$dir" -name settings.py)")

    # Get the python module name
    module=$(basename "$settings_path")
    if [ -z "$module" ]; then
        echo "Could not find settings.py, exiting..."
        return 1
    fi

    # Project name is same as module, or can be passed in as an argument
    if [ -z "$1" ]; then
        project="$module"
    else
        project=$1
    fi

    # get absolute module path
    RUNPATH=$(realpath "$settings_path/../")

    # Run a subprocess
    (
        # Add node_modules bin dir to path if it exists
        if [ -d node_modules ]; then
            PATH="$dir/node_modules/.bin":$PATH
        fi

        # Export env variables
        export PATH=$PATH \
               PYTHONPATH="$RUNPATH:$PYTHONPATH" \
               DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE:-"$module.settings"} \
               DJANGO_ENV=${DJANGO_ENV:-"dev"}

        # Start virtualenv
        workon "$project"

        # start tmux session
        if [ $? -eq 0 ]; then
            tmux-start-new-session "$project"
        fi
    )

}

# djstart command completion
_djstart_complete() {
    arg="${COMP_WORDS[COMP_CWORD]}"
    COMPREPLY=( $(ls -l $WORKON_HOME | grep ^d | awk '{print $NF}' | grep "$arg") )
}
complete -o default -o nospace -F _djstart_complete djstart

# Shortcut for running django-admin.py
dj() {
    django-admin.py "$@"
}

# dj command completion
complete -o default -F _django_completion dj
